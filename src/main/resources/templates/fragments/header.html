<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:fragment="header">
  <meta charset="utf-8">
  <link th:href="@{/css/bootstrap.min.css}"
        href="../css/bootstrap.min.css" rel="stylesheet">
  <script th:src="@{/js/bootstrap.bundle.min.js}"
          src="../js/bootstrap.bundle.min.js">
  </script>
  <script th:src="@{/js/canvasJs/canvasjs.min.js}"
          src="../js/canvasJs/canvasjs.min.js">
  </script>
  <script th:src="@{/js/jquery-3.6.2.min.js}"
          src="../js/jquery-3.6.2.min.js">
  </script>
  <script th:src="@{https://static.nid.naver.com/js/naverLogin_implicit-1.0.3.js}"
          src="https://static.nid.naver.com/js/naverLogin_implicit-1.0.3.js">
  </script>
  <script th:src="@{http://code.jquery.com/jquery-1.11.3.min.js}"
          src="http://code.jquery.com/jquery-1.11.3.min.js">
  </script>
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f03997c9ab3ebbb5b7ec9d5eab20e0e3&libraries=services"></script>
  <style>
    a {
        color: black;
        text-decoration: none;
    }
    .nav {
        --bs-nav-link-color: none;
    }
    .field-error {
        border-color: #dc3545;
        color: #dc3545;
    }
    .oauth2-login-btn {
      width: 183px;
      height: 45px;
    }
    img {
        max-height:225px;
    }
    video {
        max-height:225px;
    }
    /* memory.html 시작 */
    .SxgK2b {
      border-radius: 28px;
      cursor: pointer;
      position: absolute;
      text-align: center;
      transition: all 0.5s linear;
      left: 50%;
      margin-left: -27px;
      opacity: 0;
      fill: white;
    }
    .Cwtbxf:hover {
	  background-color:rgba(26,115,232,.25);
	  border-radius:50%;
    }
    /* memory.html 종료 */
    /* detail.html 시작 */
    /* 배경 */
    .KJca8b {
      background-color:#000;
      position:absolute;
      left:0;
      right:0;
      top:0;
      bottom:0;
    }
    /* 메뉴 바 */
    .SmZ4Wd {
      align-items:center;
      display:flex;
      justify-content:space-between;
      background-color:transparent;
      color:#fff;
      height:64px;
      left:0;
      padding:0 14px;
      position:absolute;
      right:0;
      top:0;
      z-index:200;
      transform:translateZ(0);
      transition:all 0.5s linear;
    }
    .VfPpkd-Bz112c-LgbsSe {
      /* margin:8px 0; */
      text-align:center;
      vertical-align:bottom;
      z-index:0;
      display:inline-block;
      position:relative;
      box-sizing:border-box;
      border:none;
      outline:none;
      background-color:transparent;
      fill:currentColor;
      text-decoration:none;
      cursor:pointer;
      width:48px;
      height:48px;
      padding:12px;
      --mdc-ripple-fg-size:0x;
      --mdc-ripple-left:0;
      --mdc-ripple-top:0;
      --mdc-ripple-fg-scale:1;
      --mdc-ripple-fg-translate-end:0;
      --mdc-ripple-fg-translate-start:0;
      -webkit-tap-highlight-color:rgba(0,0,0,0);
      will-change:transform,opacity;
      transition:all 0.5s linear;
      //color:#fff;
    }
    .VfPpkd-Bz112c-LgbsSe:hover {
	  background-color:rgba(90,90,90,.25);
	  border-radius:50%;
    }
    .WpHeLc {
      position:relative;
      top:-4px;
    }
    .JUQOtc {
      fill:#fff;
    }
    .xvKqge {
      color:#fff;
      display:flex;
      flex:1 1 auto;
      justify-content:flex-end;
    }
    .c9yG5b {
      align-items: center;
      display: inline-flex;
	  transition:all 0.5s linear;
    }
    .G6iPcb {
      margin: 8px 0;
      display: inline-block;
      min-width: 0;
      vertical-align: bottom;
    }
    .O8EXO {
      color:#fff;
    }
    .yHy1rc {
      z-index:0;
    }
    /* 이미지 div */
    .VmkiKe {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        top: 0;
        overflow: hidden;
        text-align: center;
        transition: all 0.5s linear;
    }
    .VmkiKe:after {
      display:inline-block;
      height:100%;
      content:"";
      vertical-align:middle;
    }
    /* 사이드 바 */
    .sideBar {
        position:absolute;
        top:0;
        bottom:0;
        right:0;
        width:360px;
        overflow-y:auto;
        transform:translate3d(360px, 0, 0);
        transition:transform 0.5s linear;
        background-color:#fff;
        z-index:1;
    }
    .IMbeAf {
      font-family: "Google Sans",Roboto,Arial,sans-serif;
      line-height: 1.5rem;
      font-size: 1.125rem;
      letter-spacing: 0;
      font-weight: 400;
      display: flex;
      -ms-flex-pack: justify;
      align-items: center;
      -ms-flex-align: center;
      flex-direction: row-reverse;
      justify-content: flex-end;
      padding: 8px;
    }
    .zE2Vqb {
      padding: 20px 24px;
    }
    .qURWqc {
      font-family: Roboto,Arial,sans-serif;
      line-height: 1.5rem;
      font-size: 1rem;
      letter-spacing: .00625em;
      font-weight: 400;
      /* white-space: pre-wrap; */
      word-wrap: break-word;
    }
    .Mna4i {
      line-height: 1.5rem;
      position: relative;
    }
    .n4jc2d {
      padding-bottom: 1px;
      /* white-space: pre-wrap; */
      word-wrap: break-word;
    }
    .ajQY2 {
      border: none;
      border-bottom: 1px solid rgba(0,0,0,.12);
      bottom: 0;
      box-sizing: border-box;
      color: inherit;
      display: block;
      font: inherit;
      height: 100%;
      letter-spacing: inherit;
      margin: 0;
      outline: none;
      overflow: hidden;
      padding: 0;
      resize: none;
      top: 0;
      transition: .3s cubic-bezier(.4,0,.2,1) all;
      width: 100%;
    }
    .ajQY2:focus {
      border-bottom: 1px solid rgb(66,133,244);
    }
    .wiOkb {
      color: rgb(95,99,104);
      display: flex;
      padding: 14px 24px;
      font-family: Roboto,Arial,sans-serif;
      line-height: 1rem;
      font-size: .6875rem;
      letter-spacing: .0727272727em;
      font-weight: 500;
      text-transform: uppercase;
    }
    .Kd04rd {
      position: relative;
    }
    .Kd04rd:hover {
        background-color: rgb(241,243,244);
    }
    .ffq9nc {
      display: flex;
      padding: 18px 24px;
    }
    .dNjXAc {
      height: 24px;
      min-width: 40px;
      width: 40px;
    }
    .Y0p3Ue {
      fill:rgba(0,0,0,.54);
    }
    .rCexAf {
      margin: 0;
      overflow: hidden;
    }
    .R9U8ab {
      color: rgb(60,64,67);
      word-wrap: break-word;
      font-family: Roboto,Arial,sans-serif;
      line-height: 1.5rem;
      font-size: 1rem;
      letter-spacing: .00625em;
      font-weight: 400;
    }
    .oBMhZb {
      align-items: center;
      color: rgb(95,99,104);
      display: flex;
      flex-wrap: wrap;
      margin-top: 0;
      font-family: Roboto,Arial,sans-serif;
      line-height: 1.25rem;
      font-size: .875rem;
      letter-spacing: .0142857143em;
      font-weight: 400;
    }
    .cFLCHe {
      display: block;
      background-color: #fff;
      background-position: 50% 50%;
      background-size: 360px;
      height: 360px;
      text-align: center;
    }
    /* detail.html 종료 */
    /* walk.html 시작 */
    .searchBar {
      position:absolute;
      top:0;
      /* bottom:0; */
      left:0;
      width:360px;
      overflow-y:auto;
      transform:translate3d(0, 0, 0);
      transition:transform 0.5s linear;
      background-color:#fff;
      z-index:1;
      padding:8px;
    }
    .searchPetName {
      font-size:1.125rem;
      padding:8px;
    }
    .searchDate {
      padding:8px;
    }
    .searchDate div {
      display:flex;
    }
    .searchDate input[type="date"] {
      width:150px;
    }
    .searchDate span {
      line-height:38px;
    }
    /* walk.html 종료 */
  </style>
  <script>
    /* 월 */
    let months = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
    /* 요일 */
    let days = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일']
    /* 펫 등록 폼 시작 */
    function selectPetType(petTypeId) {
      $('#breedId').children('option:not(:first)').remove();
      if (petTypeId != '') {
        $.ajax({
          url : "/pets/petBreeds/" + petTypeId,
          type : "get",
          contentType:"application/json;charset=UTF-8",
          async: false,
          success : function(data) {
            if (data == null) {
              alert('Error');
            }
            for (idx in data) {
              var value = data[idx];
              $('#breedId').append("<option value='" + value.id + "'>" + value.breed + "</option>")
            }
          },
          error: function(xhr, status, error){
             alert(xhr.responseText);
          },
        });
      }
    }
    /* 펫 등록 폼 종료 */
    /* 메모리 등록 폼 시작 */
    function checkFiles(form) {
      var files = form.querySelector('input[type="file"]').files;
      var length = files.length;
      if (length > 0) {
        return true;
      }
      return false;
    }
    /* 메모리 등록 폼 종료 */
    /* 펫별 메모리 페이지 시작 */
    function showImageMenu(id) {
      var parent = document.getElementById(id);
      parent.getElementsByClassName('SxgK2b')[0].style.opacity = 1;
    }
    function hideImageMenu(id) {
      var parent = document.getElementById(id);
      parent.getElementsByClassName('SxgK2b')[0].style.opacity = 0;
    }
    /* 펫별 메모리 페이지 종료 */
    /* 메모리 상세 페이지 시작 */
    function showDetailSideBar() {
      let right = '0px';
      let pushRight = '360px';
      pushSideBar(right);
      pushAsideTopMenu(pushRight);
      pushAsideImage(pushRight);
      let info = document.getElementsByClassName('info')[0];
      info.setAttribute('onclick', 'hideDetailSideBar()');
    }
    function hideDetailSideBar() {
      let right = '360px';
      let pushRight = '0px';
      pushSideBar(right);
      pushAsideTopMenu(pushRight);
      pushAsideImage(pushRight);
      let info = document.getElementsByClassName('info')[0];
      info.setAttribute('onclick', 'showDetailSideBar()');
    }
    function pushSideBar(right) {
      let className = 'sideBar';
      let sideBar = document.getElementsByClassName(className)[0];
      sideBar.style.transform = 'translate3d(' + right + ', 0, 0)';
    }
    function pushAsideTopMenu(right) {
      let topMenuName = 'SmZ4Wd';
      let topMenu = document.getElementsByClassName(topMenuName)[0];
      topMenu.style.right = right;
    }
    function pushAsideImage(right) {
      let imageDivName = 'VmkiKe';
      let imageDiv = document.getElementsByClassName(imageDivName)[0];
      imageDiv.style.right = right;
    }
    function changeMemoryInfo(info, memoryId) {
      var json = {"memoryId" : memoryId, "info" : info}

      $.ajax({
        url : "/memories/memory/detail/update/info",
        type : "post",
        data : JSON.stringify(json),
        contentType:"application/json;charset=UTF-8",
	    async: false,
	    success : function(data) {
	      if (data == null) {
	        alert('Error');
	      }
	    },
	    error: function(xhr, status, error){
	       alert(xhr.responseText);
	    },
      });
    }
    function showMap(gps) {
      if (gps != null) {
        var latitude = gps.latitude;
        var longitude = gps.longitude;
        showAddress(latitude, longitude);  // 주소 표시 함수
        var map = makeMap(latitude, longitude);
        drawMarker(latitude, longitude, map, 'start');
      }
    }
    function showAddress(x, y) {
      var geocoder = new kakao.maps.services.Geocoder();

      var coord = new kakao.maps.LatLng(x, y);
      var callback = function(result, status) {
          if (status === kakao.maps.services.Status.OK) {
              var address = document.getElementById('address');
              address.innerText = result[0].address.address_name;
          }
      };

      geocoder.coord2Address(coord.getLng(), coord.getLat(), callback);
    }
    function makeMap(latitude, longitude) {
        var mapContainer = document.getElementById('map'), // 지도를 표시할 div
        mapOption = {
            center: new kakao.maps.LatLng(latitude, longitude), // 지도의 중심좌표
            level: 5 // 지도의 확대 레벨
        };
        // 지도를 표시할 div와  지도 옵션으로  지도를 생성합니다
        return new kakao.maps.Map(mapContainer, mapOption);
    }

    function drawMarker(latitude, longitude, map, opt) {
        var markerPosition  = new kakao.maps.LatLng(latitude, longitude);

        var imageSrc = '';

        // 마커를 생성합니다
        var marker = new kakao.maps.Marker({
            position : markerPosition
        });

        // 마커가 지도 위에 표시되도록 설정합니다
        marker.setMap(map);
    }
    /* 메모리 상세 페이지 종료 */
    /* 체중 페이지 시작 */
    function showChart(weightsArr, petName) {
      var weights = [];
      for (var i = 0; i < weightsArr.length; i++) {
        weights.push({
          x : new Date(weightsArr[i].date),
          y : weightsArr[i].weight
        });
      }
      var chart = new CanvasJS.Chart("petWeightChart",
      {
          title: {
              text: petName
          },
          axisX:{
            title: "",
            valueFormatString: "YYYY-MM-DD",
          },
          axisY: {
            title: "",
		    suffix: " kg",
		    includeZero: true
        },
        data: [{
          type: "spline",
          xValueType: "dateTime",
          xValueFormatString: "YYYY-MM-DD",
          yValueFormatString: "#,##0.## kg",
          dataPoints: weights
        }]
      });
      chart.render();
    }
    function isEmpty(data) {
      if (data == "") {
        return true;
      }

      return false;
    }
    function isSameDate(id) {
      return document.getElementById(id);
    }
    function checkWeightData() {
      alert("[[#{existDate.weightForm.date}]]");
      alert("[[#{wrongDate.walkForm.walkDate}]]");
      var form = document.weightForm;
      var dateVal = form.date.value;
      var weightVal = form.weight.value;

      if (isEmpty(dateVal)) {
        alert("[[#{NotNull.weightForm.date}]]");
        return false;
      } else if (isSameDate(dateVal)) {
        alert("[[#{existDate.weightForm.date}]]");
        return false;
      }

      if (isEmpty(weightVal)) {
        alert("[[#{NotNull.weightForm.weight}]]");
        return false;
      }

      return true;
    }
    function deleteWeight(page, text) {
      if (confirm(text)) {
        window.location.replace(page);
      }
    }
    /* 체중 페이지 종료 */
    /* 산책 경로 페이지 시작 */
    function showWalkMap(dataList) {
      var latitude = 37.53650277777778; // 초기값
      var longitude = 126.950225; // 초기값
      circles = [];
      linePath = [];
      if (dataList.length > 0) {
        map = makeMap(dataList[dataList.length - 1].gps.latitude, dataList[dataList.length - 1].gps.longitude);
        for (var index in dataList) {
          latitude = dataList[index].gps.latitude;
          longitude = dataList[index].gps.longitude;
          var circle = drawCircle(new kakao.maps.LatLng(latitude, longitude), map);
          clickPolygonEvent(map, circle, dataList[index].memoryId);
          makeChangeColor(circle, 'red', 'blue');
          circles.push(circle);
          linePath.push(new kakao.maps.LatLng(latitude, longitude));
        }
        drawLine(linePath, map);
      } else {
        var map = makeMap(latitude, longitude);
      }
      //drawMarker(latitude, longitude, map, 'last');
    }
    function drawCircle(center, map) {
      var circle = new kakao.maps.Circle({
          center : center,  // 원의 중심좌표 입니다
          radius: 8, // 미터 단위의 원의 반지름입니다
          strokeWeight: 3, // 선의 두께입니다
          strokeColor: 'blue', // 선의 색깔입니다
          strokeOpacity: 0, // 선의 불투명도 입니다 1에서 0 사이의 값이며 0에 가까울수록 투명합니다
          strokeStyle: 'line', // 선의 스타일 입니다
          fillColor: 'blue', // 채우기 색깔입니다
          fillOpacity: 1,  // 채우기 불투명도 입니다
          zIndex: 2
      });

      // 지도에 원을 표시합니다
      circle.setMap(map);

      return circle;
    }
    function makeChangeColor(polygon, overColor, outColor) {
      // 다각형에 마우스오버 이벤트가 발생했을 때 변경할 채우기 옵션입니다
      var mouseoverOption = {
          fillColor: overColor, // 채우기 색깔입니다
          fillOpacity: 1 // 채우기 불투명도 입니다
      };

      // 다각형에 마우스아웃 이벤트가 발생했을 때 변경할 채우기 옵션입니다
      var mouseoutOption = {
          fillColor: outColor, // 채우기 색깔입니다
          fillOpacity: 1 // 채우기 불투명도 입니다
      };

      // 다각형에 마우스오버 이벤트를 등록합니다
      kakao.maps.event.addListener(polygon, 'mouseover', function(mouseEvent) {
          // 다각형의 채우기 옵션을 변경합니다
          polygon.setOptions(mouseoverOption);
      });

      kakao.maps.event.addListener(polygon, 'mouseout', function(mouseEvent) {
          // 다각형의 채우기 옵션을 변경합니다
          polygon.setOptions(mouseoutOption);
      });
    }
    function moveCenter(map, polygon) {
      map.panTo(polygon.getPosition());
    }

    function clickPolygonEvent(map, polygon, memoryId) {
      kakao.maps.event.addListener(polygon, 'click', function() {
        moveCenter(map, polygon);
        showWalkInfo(memoryId);
        showWalkSideBar(memoryId);
      });
    }

    function showWalkSideBar(memoryId) {
      let right = '0px';
      let pushRight = '360px';
      pushSideBar(right);
      let info = document.getElementsByClassName('ajQY2')[0];
      info.setAttribute('onchange', 'changeMemoryInfo(this.value, ' + memoryId + ')');
    }

    function hideWalkSideBar() {
      let right = '430px';
      let pushRight = '0px';
      pushSideBar(right);
      pushAsideTopMenu(pushRight);
      pushAsideImage(pushRight);
    }

    function showWalkInfo(memoryId) {
      $.ajax({
        url : "/memories/walk/info/" + memoryId,
        type : "get",
        success : function(data) {
          if (data == null) {
            alert('Error');
          } else {
            // info 보여주기
            let info = document.getElementsByClassName('ajQY2')[0];
            info.value = data.info;
            // imageTime 보여주기
            let date = changeDateFormat(data.imageTime);
            let dayName = getDay(data.imageTime);
            document.getElementById('date').innerText = date;
            document.getElementById('day').innerText = dayName;
            // uploadFileName 보여주기
            document.getElementById('uploadFileName').innerText = data.uploadFile.uploadFileName;
            // imageSize 보여주기
            if (data.imageSize != null) {
              document.getElementById('imageSize').innerText = data.imageSize.width + 'x' + data.imageSize.height;
            }
            showAddress(data.gps.latitude, data.gps.longitude);
            document.getElementById('image').src = '/images/' + data.uploadFile.saveFileName;
            // address는 일단 보류하고 마지막에 하기
          }
        },
        error: function(xhr, status, error){
           alert(xhr.responseText);
        },
      });
    }

    function getDay(imageTime) {
      if (imageTime == null) {
        return '';
      }
      let date = new Date(imageTime);
      return days[date.getDay()];
    }

    function drawLine(linePath, map) {
      if (linePath.length > 1) {
        // 지도에 표시할 선을 생성합니다
        var polyline = new kakao.maps.Polyline({
            //endArrow: true, // 화살표 표시
            path: linePath, // 선을 구성하는 좌표배열 입니다
            strokeWeight: 5, // 선의 두께 입니다
            strokeColor: 'blue', // 선의 색깔입니다
            strokeOpacity: 0.5, // 선의 불투명도 입니다 1에서 0 사이의 값이며 0에 가까울수록 투명합니다
            strokeStyle: 'solid', // 선의 스타일입니다
            zIndex: 1
        });

        // 지도에 선을 표시합니다
        polyline.setMap(map);
      }
    }

    function showAddress(x, y) {
      var geocoder = new kakao.maps.services.Geocoder();

      var coord = new kakao.maps.LatLng(x, y);
      var callback = function(result, status) {
          if (status === kakao.maps.services.Status.OK) {
              var address = document.getElementById('address');
              address.innerText = result[0].address.address_name;
          }
      };

      geocoder.coord2Address(coord.getLng(), coord.getLat(), callback);
    }

    function searchWalkData(petId) {
      var startTime = document.getElementById('startTime').value;
      var endTime = document.getElementById('endTime').value;

      var json = {"pet" : petId, "startTime" : startTime, "endTime" : endTime}

      if (startTime > endTime) {
        alert("[[#{wrongDate.walkForm.walkDate}]]");
      } else {
        $.ajax({
          url : "/memories/walk",
          type : "post",
        data : JSON.stringify(json),
          contentType:"application/json;charset=UTF-8",
          async: false,
          success : function(data) {
            showWalkMap(data);
          },
          error: function(xhr, status, error){
             alert(xhr.responseText);
          },
        });
      }
    }

    function changeDateFormat(imageTime) {
      if (imageTime == null) {
        return '';
      }
      let date = new Date(imageTime);
      let yearName = date.getFullYear() + '년';
      let monthName = months[date.getMonth()];
      let day = date.getDate() + "일";
      let timeOpt = date.getHours() < 12 ? "오전 " : "오후 ";
      let hour = date.getHours() > 12 ? date.getHours() == 24 ? 0 : date.getHours() - 12 : date.getHours();
      let hourName = timeOpt + hour;
      let minuteName = date.getMinutes();
      let secondName = date.getSeconds();
      return [[yearName, monthName, day].join(' '), [hourName, minuteName, secondName].join(':')].join(' ');
    }

    /* 산책 경로 페이지 종료 */
  </script>
</head>
<body>
</body>
</html>